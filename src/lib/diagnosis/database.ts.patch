// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// src/lib/diagnosis/database.ts ìˆ˜ì • ì‚¬í•­
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. íŒŒì¼ ìƒë‹¨ì— supabase import ì¶”ê°€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import { supabase } from '@/lib/supabase/client';


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. getNextConsultationNumberFromSupabase í•¨ìˆ˜ ì™„ì „ êµì²´
//    (ê¸°ì¡´: 878-906ì¤„, ìƒˆ ë²„ì „ìœ¼ë¡œ êµì²´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * íšŒìƒí„°ì¹˜ ë²ˆí˜¸ ìƒì„± (Supabase ì‹œí€€ìŠ¤ ê¸°ë°˜ - ì¤‘ë³µ ë¶ˆê°€)
 */
private static async getNextConsultationNumberFromSupabase(): Promise<string> {
  try {
    console.log('ğŸ”¢ íšŒìƒí„°ì¹˜ ë²ˆí˜¸ ìƒì„± ì‹œì‘ (ì‹œí€€ìŠ¤ ê¸°ë°˜)');
    
    // Supabase í•¨ìˆ˜ í˜¸ì¶œ (ì›ìì  ì¦ê°€)
    const { data, error } = await supabase.rpc('get_next_consultation_number');
    
    if (error) {
      console.error('âŒ ë²ˆí˜¸ ìƒì„± ì‹¤íŒ¨:', error);
      
      // ì—ëŸ¬ ë¡œê·¸ ì €ì¥
      await this.logError({
        errorType: 'number_generation_failed',
        errorMessage: error.message,
        errorDetails: error
      });
      
      throw new Error(`ë²ˆí˜¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
    }
    
    const nextNumber = data;
    const consultationName = `íšŒìƒí„°ì¹˜${nextNumber}`;
    
    console.log('âœ… íšŒìƒí„°ì¹˜ ë²ˆí˜¸ ìƒì„± ì„±ê³µ:', consultationName);
    return consultationName;
    
  } catch (error) {
    console.error('âŒ íšŒìƒí„°ì¹˜ ë²ˆí˜¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
    
    // ìµœí›„ì˜ ë°±ì—…: íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ ì„ì‹œ ë²ˆí˜¸
    const timestamp = Date.now();
    const tempName = `íšŒìƒí„°ì¹˜-ì„ì‹œ-${timestamp}`;
    console.warn('âš ï¸ ì„ì‹œ ë²ˆí˜¸ ì‚¬ìš©:', tempName);
    
    // ì—ëŸ¬ ë¡œê·¸
    await this.logError({
      errorType: 'number_generation_critical_failed',
      errorMessage: error instanceof Error ? error.message : String(error),
      errorDetails: { timestamp, tempName }
    });
    
    return tempName;
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. saveRecord í•¨ìˆ˜ì˜ Supabase ì €ì¥ ë¶€ë¶„ êµì²´
//    (ê¸°ì¡´: 323-349ì¤„, ì¬ì‹œë„ + ì—ëŸ¬ ë¡œê¹… ì¶”ê°€)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Supabaseì—ë„ ì €ì¥ (ì¬ì‹œë„ 3íšŒ)
let supabaseId: string | undefined;
const maxRetries = 3;
const retryDelay = 1000; // 1ì´ˆ

for (let attempt = 1; attempt <= maxRetries; attempt++) {
  try {
    console.log(`ğŸ”„ Supabase ì €ì¥ ì‹œë„ ${attempt}/${maxRetries}...`);
    
    const response = await fetch('/api/supabase/saveRecord', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(record),
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    
    if (result.success && result.data) {
      supabaseId = result.data.id;
      console.log(`âœ… Supabase ì €ì¥ ì„±ê³µ! (${attempt}ë²ˆì§¸ ì‹œë„) ID:`, supabaseId);
      break; // ì„±ê³µí•˜ë©´ ë£¨í”„ íƒˆì¶œ
      
    } else {
      throw new Error(result.error || 'Unknown error');
    }
    
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(`âŒ Supabase ì €ì¥ ì‹œë„ ${attempt} ì‹¤íŒ¨:`, errorMessage);
    
    // ë§ˆì§€ë§‰ ì‹œë„ì—ì„œë„ ì‹¤íŒ¨í•œ ê²½ìš°
    if (attempt === maxRetries) {
      console.error('âŒ Supabase ì €ì¥ ìµœì¢… ì‹¤íŒ¨ (3íšŒ ì‹œë„)');
      
      // ì—ëŸ¬ ë¡œê·¸ ì €ì¥
      await this.logError({
        errorType: 'supabase_save_failed',
        consultationNumber: (record as any).contactInfo?.name || 'unknown',
        customerPhone: (record as any).contactInfo?.phone || 'unknown',
        customerResidence: (record as any).contactInfo?.residence || 'unknown',
        acquisitionSource: record.acquisitionSource,
        errorMessage: errorMessage,
        errorDetails: {
          recordId: record.id,
          attempts: maxRetries,
          lastError: error
        },
        retryCount: maxRetries
      });
      
      // Slack ì•Œë¦¼ ì „ì†¡
      try {
        await fetch('/api/slack/notify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'error',
            customerName: (record as any).contactInfo?.name || 'unknown',
            consultationType: (record as any).contactInfo?.consultationType || 'unknown',
            acquisitionSource: record.acquisitionSource,
            error: `Supabase ì €ì¥ ì‹¤íŒ¨ (3íšŒ ì‹œë„): ${errorMessage}`,
            attempts: maxRetries,
            phone: (record as any).contactInfo?.phone
          })
        });
      } catch (slackError) {
        console.error('Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', slackError);
      }
      
    } else {
      // ì¬ì‹œë„ ì „ ëŒ€ê¸°
      console.log(`â³ ${retryDelay}ms í›„ ì¬ì‹œë„...`);
      await new Promise(resolve => setTimeout(resolve, retryDelay));
    }
  }
}

// âš ï¸ ì¤‘ìš”: Supabase ì €ì¥ ì‹¤íŒ¨í•´ë„ ì‚¬ìš©ìì—ê²ŒëŠ” ì„±ê³µ ë©”ì‹œì§€
// ì´ìœ : í™ˆí˜ì´ì§€ API ë“±ë¡ì€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ìƒë‹´ì€ ì ‘ìˆ˜ëœ ìƒíƒœ
return { ...record, supabaseId };


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. ìƒˆë¡œìš´ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€ (íŒŒì¼ ëë¶€ë¶„ì—)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * ì—ëŸ¬ ë¡œê·¸ ì €ì¥ (Supabase)
 */
private static async logError(errorData: {
  errorType: string;
  consultationNumber?: string;
  customerPhone?: string;
  customerResidence?: string;
  acquisitionSource?: string;
  errorMessage: string;
  errorDetails?: any;
  retryCount?: number;
}): Promise<void> {
  try {
    const { error } = await supabase
      .from('consultation_error_logs')
      .insert([{
        error_type: errorData.errorType,
        consultation_number: errorData.consultationNumber,
        customer_phone: errorData.customerPhone,
        customer_residence: errorData.customerResidence,
        acquisition_source: errorData.acquisitionSource,
        error_message: errorData.errorMessage,
        error_details: errorData.errorDetails,
        retry_count: errorData.retryCount || 0
      }]);
    
    if (error) {
      console.error('ì—ëŸ¬ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', error);
    } else {
      console.log('âœ… ì—ëŸ¬ ë¡œê·¸ ì €ì¥ ì„±ê³µ');
    }
  } catch (err) {
    console.error('ì—ëŸ¬ ë¡œê·¸ ì €ì¥ ì¤‘ ì˜ˆì™¸:', err);
  }
}

